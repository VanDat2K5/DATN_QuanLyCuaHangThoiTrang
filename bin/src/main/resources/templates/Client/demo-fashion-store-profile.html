<!doctype html>
<html class="no-js" lang="en" xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>Profile - StyleTech Store</title>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="author" content="ThemeZaa">
        <meta name="viewport" content="width=device-width,initial-scale=1.0" />
        <meta name="description" content="Profile">
        <!-- favicon icon -->
        <link rel="shortcut icon" href="/images/favicon.png">
        <link rel="apple-touch-icon" href="/images/apple-touch-icon-57x57.png">
        <link rel="apple-touch-icon" sizes="72x72" href="/images/apple-touch-icon-72x72.png">
        <link rel="apple-touch-icon" sizes="114x114" href="/images/apple-touch-icon-114x114.png">
        <!-- google fonts preconnect -->
        <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <!-- style sheets and font icons  -->
        <link rel="stylesheet" href="/css/vendors.min.css"/>
        <link rel="stylesheet" href="/css/icon.min.css"/>
        <link rel="stylesheet" href="/css/style.css"/>
        <link rel="stylesheet" href="/css/responsive.css"/>
        <link rel="stylesheet" href="/demos/fashion-store/fashion-store.css" />
        <!-- Bootstrap CSS fallback -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <!-- Feather Icons fallback -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/feather-icons@4.29.0/dist/feather.min.css">
        <!-- Profile specific styles -->
        <link rel="stylesheet" th:href="@{/css/profile.css}" />
    </head>
    <body data-mobile-nav-style="classic">
        <div th:replace="Client/header :: header"></div>
        
        <!-- start section -->
        <section class="top-space-margin half-section bg-gradient-very-light-gray">
            <div class="container">
                <div class="row align-items-center justify-content-center" data-anime='{ "el": "childs", "translateY": [-15, 0], "opacity": [0,1], "duration": 300, "delay": 0, "staggervalue": 200, "easing": "easeOutQuad" }'>
                    <div class="col-12 col-xl-8 col-lg-10 text-center position-relative page-title-extra-large">
                        <h1 class="alt-font fw-600 text-dark-gray mb-10px">My Profile</h1> 
                    </div>
                    <div class="col-12 breadcrumb breadcrumb-style-01 d-flex justify-content-center">
                        <ul>
                            <li><a href="/">Home</a></li> 
                            <li>Profile</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
        <!-- end section -->

        <!-- start section -->
        <section class="pt-0 pb-5">
            <div class="container">
                <!-- Alert Messages -->
                <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="feather icon-feather-check-circle me-2"></i>
                    <span th:text="${success}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="feather icon-feather-alert-circle me-2"></i>
                    <span th:text="${error}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <div class="row">
                    <!-- Profile Card -->
                    <div class="col-lg-4 mb-4">
                        <div class="profile-card text-center">
                            <div class="profile-avatar">
                                <i class="feather icon-feather-user"></i>
                            </div>
                            <h3 class="mb-2" th:text="${userRole == 'CUSTOMER' ? user.tenKH : user.tenNV}">User Name</h3>
                            <p class="mb-3" th:text="${userRole == 'CUSTOMER' ? 'Customer' : (userRole == 'ADMIN' ? 'Administrator' : 'Employee')}">Role</p>
                            <div class="d-flex justify-content-center gap-2">
                                <span class="badge bg-light text-dark" th:text="${username}">Username</span>
                                <span class="badge bg-light text-dark" th:text="${userRole}">Role</span>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Content -->
                    <div class="col-lg-8">
                        <ul class="nav nav-tabs" id="profileTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">
                                    <i class="feather icon-feather-bar-chart-2 me-2"></i>Dashboard
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab">
                                    <i class="feather icon-feather-user me-2"></i>Personal Info
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="edit-tab" data-bs-toggle="tab" data-bs-target="#edit" type="button" role="tab">
                                    <i class="feather icon-feather-edit me-2"></i>Edit Profile
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="password-tab" data-bs-toggle="tab" data-bs-target="#password" type="button" role="tab">
                                    <i class="feather icon-feather-lock me-2"></i>Change Password
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content" id="profileTabsContent">
                            <!-- Dashboard Tab -->
                            <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="stats-card">
                                            <div class="stats-icon">
                                                <i class="feather icon-feather-shopping-bag"></i>
                                            </div>
                                            <div class="stats-number" th:text="${totalOrders}">0</div>
                                            <div class="stats-label">
                                                <span th:text="${userRole == 'CUSTOMER' ? 'Total Orders' : 'Orders Processed'}">Total Orders</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="stats-card">
                                            <div class="stats-icon">
                                                <i class="feather icon-feather-dollar-sign"></i>
                                            </div>
                                            <div class="stats-number" th:text="${#numbers.formatDecimal(totalSpent, 0, 'COMMA', 0, 'POINT')}">0</div>
                                            <div class="stats-label">
                                                <span th:text="${userRole == 'CUSTOMER' ? 'Total Spent' : 'Total Processed'}">Total Spent</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="stats-card">
                                            <div class="stats-icon">
                                                <i class="feather icon-feather-trending-up"></i>
                                            </div>
                                            <div class="stats-number" th:text="${ordersByStatus != null ? ordersByStatus.get('DaNhanHang') : 0}">0</div>
                                            <div class="stats-label">Completed</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Recent Orders -->
                                <div class="mt-4">
                                    <h5 class="mb-3">
                                        <i class="feather icon-feather-clock me-2"></i>
                                        Recent Orders
                                    </h5>
                                    <div th:if="${recentOrders != null and !recentOrders.empty}">
                                        <div class="order-item" th:each="order : ${recentOrders}" th:with="isChoXacNhan=${order.trangThai == 'ChoXacNhan'}, isDaThanhToan=${order.trangThai == 'DaThanhToan'}">
                                            <div class="row align-items-center">
                                                <div class="col-md-2">
                                                    <strong th:text="${order.maHD}">Order ID</strong>
                                                </div>
                                                <div class="col-md-2">
                                                    <span th:text="${#temporals.format(order.ngayLap, 'dd/MM/yyyy')}">Date</span>
                                                </div>
                                                <div class="col-md-2">
                                                    <span th:text="${#numbers.formatDecimal(order.tongTien, 0, 'COMMA', 0, 'POINT')}">money</span>
                                                </div>
                                                <div class="col-md-2">
                                                    <span class="status-badge" th:class="'status-' + ${order.trangThai}" th:text="${order.trangThai}">Status</span>
                                                </div>
                                                <div class="col-md-2">
                                                    <span th:text="${order.ptThanhToan}">Payment</span>
                                                </div>
                                                <div class="col-md-2">
                                                    <div class="d-flex gap-1">
                                                        <!-- QR Code Button for unpaid orders -->
                                                        <button th:if="${isChoXacNhan}" 
                                                                class="btn btn-sm btn-outline-primary qr-btn" 
                                                                th:data-order-id="${order.maHD}"
                                                                th:data-order-money="${order.tongTien}"
                                                                th:data-username="${username}"
                                                                title="Xem mã QR thanh toán">
                                                            <i class="feather icon-feather-qr-code"></i>
                                                        </button>
                                                        
                                                        <!-- Cancel Button for specific statuses -->
                                                        <form th:if="${isChoXacNhan or isDaThanhToan}" 
                                                              th:action="@{/user/order/cancel}" 
                                                              method="post" 
                                                              style="display: inline;"
                                                              onsubmit="return confirm('Bạn có chắc muốn hủy đơn hàng này?')">
                                                            <input type="hidden" name="orderId" th:value="${order.maHD}">
                                                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Hủy đơn hàng">
                                                                <i class="feather icon-feather-x"></i>
                                                            </button>
                                                        </form>
                                                        
                                                        <!-- View Details Button -->
                                                        <a href="#" class="btn btn-sm btn-outline-info" title="Xem chi tiết">
                                                            <i class="feather icon-feather-eye"></i>
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div th:if="${recentOrders == null or recentOrders.empty}" class="text-center py-4">
                                        <i class="feather icon-feather-inbox fs-48 text-muted mb-3"></i>
                                        <p class="text-muted">No orders found</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Personal Info Tab -->
                            <div class="tab-pane fade" id="info" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="info-item">
                                            <div class="info-icon">
                                                <i class="feather icon-feather-user"></i>
                                            </div>
                                            <div class="info-content">
                                                <h6>Full Name</h6>
                                                <p th:text="${userRole == 'CUSTOMER' ? user.tenKH : user.tenNV}">Full Name</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="info-item">
                                            <div class="info-icon">
                                                <i class="feather icon-feather-mail"></i>
                                            </div>
                                            <div class="info-content">
                                                <h6>Email</h6>
                                                <p th:text="${user.email}">email@example.com</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="info-item">
                                            <div class="info-icon">
                                                <i class="feather icon-feather-phone"></i>
                                            </div>
                                            <div class="info-content">
                                                <h6>Phone Number</h6>
                                                <p th:text="${user.soDT}">Phone Number</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="info-item">
                                            <div class="info-icon">
                                                <i class="feather icon-feather-shield"></i>
                                            </div>
                                            <div class="info-content">
                                                <h6>Account Type</h6>
                                                <p th:text="${userRole == 'CUSTOMER' ? 'Customer Account' : (userRole == 'ADMIN' ? 'Administrator Account' : 'Employee Account')}">Account Type</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Edit Profile Tab -->
                            <div class="tab-pane fade" id="edit" role="tabpanel">
                                <form th:action="@{/user/profile/update}" method="post">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Full Name</label>
                                            <input type="text" class="form-control" name="fullName" 
                                                   th:value="${userRole == 'CUSTOMER' ? user.tenKH : user.tenNV}" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Email</label>
                                            <input type="email" class="form-control" name="email" 
                                                   th:value="${user.email}" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Phone Number</label>
                                            <input type="tel" class="form-control" name="phone" 
                                                   th:value="${user.soDT}" required>
                                        </div>
                                        <div class="col-12">
                                            <button type="submit" class="btn edit-btn">
                                                <i class="feather icon-feather-save me-2"></i>Update Profile
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>

                            <!-- Change Password Tab -->
                            <div class="tab-pane fade" id="password" role="tabpanel">
                                <form th:action="@{/user/profile/change-password}" method="post">
                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <label class="form-label">Current Password</label>
                                            <input type="password" class="form-control" name="currentPassword" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">New Password</label>
                                            <input type="password" class="form-control" name="newPassword" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Confirm New Password</label>
                                            <input type="password" class="form-control" name="confirmPassword" required>
                                        </div>
                                        <div class="col-12">
                                            <button type="submit" class="btn edit-btn">
                                                <i class="feather icon-feather-lock me-2"></i>Change Password
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- end section -->

        <!-- QR Code Modal -->
        <div class="modal fade qr-modal" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="qrModalLabel">
                            <i class="feather icon-feather-qr-code me-2"></i>
                            Mã QR Thanh Toán
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Order Details -->
                        <div class="order-details">
                            <div class="row text-center">
                                <div class="col-md-4">
                                    <h6>Mã đơn hàng</h6>
                                    <p class="mb-0" id="modalOrderId">Order ID</p>
                                </div>
                                <div class="col-md-4">
                                    <h6>Tổng tiền</h6>
                                    <p class="mb-0" id="modalOrdermoney">money</p>
                                </div>
                                <div class="col-md-4">
                                    <h6>Phương thức</h6>
                                    <p class="mb-0" id="modalPaymentMethod">Payment Method</p>
                                </div>
                            </div>
                        </div>

                        <!-- QR Code -->
                        <div class="qr-code-container">
                            <h5 class="mb-3">
                                <i class="feather icon-feather-qr-code me-2"></i>
                                Mã QR thanh toán
                            </h5>
                            <div id="qrcode" class="mb-3"></div>
                            <p class="text-muted mb-0">
                                <small>Quét mã QR bằng ứng dụng ngân hàng để thanh toán</small>
                            </p>
                        </div>

                        <!-- Payment Instructions -->
                        <div class="qr-instructions">
                            <h6>
                  <i class="feather icon-feather-info me-2"></i>
                                Hướng dẫn thanh toán
                            </h6>
                            <ol>
                                <li>Mở ứng dụng ngân hàng trên điện thoại</li>
                                <li>Chọn tính năng "Quét mã QR" hoặc "Thanh toán QR"</li>
                                <li>Quét mã QR bên trên</li>
                                <li>Kiểm tra thông tin đơn hàng và số tiền</li>
                                <li>Xác nhận thanh toán</li>
                                <li>Lưu lại biên lai thanh toán</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div th:replace="Client/footer :: footer"></div>
        
        <!-- javascript libraries -->
        <script type="text/javascript" th:src="@{/js/jquery.js}"></script>
        <script type="text/javascript" th:src="@{/js/vendors.min.js}"></script>
        <script type="text/javascript" th:src="@{/js/main.js}"></script>
        
        
        <script th:src="@{/js/qrcode.js}"></script>
        <script>
            // Add event listeners when document is ready
            document.addEventListener('DOMContentLoaded', function() {
                // Add click event listeners to QR buttons
                document.querySelectorAll('.qr-btn').forEach(function(button) {
                    button.addEventListener('click', function() {
                        const orderId = this.getAttribute('data-order-id');
                        const money = this.getAttribute('data-order-money');
                        const username = this.getAttribute('data-username');
                        
                        // Update modal content
                        document.getElementById('modalOrderId').textContent = orderId;
                        document.getElementById('modalOrdermoney').textContent = formatCurrency(money) + ' VNĐ';
                        document.getElementById('modalPaymentMethod').textContent = 'QR Code';
                        
                        // Generate QR code using the existing function
                        generateQRCode(money, orderId + ' - ' + username);
                        
                        // Show modal
                        const modal = new bootstrap.Modal(document.getElementById('qrModal'));
                        modal.show();
                    });
                });
            });
            
            // Function to format currency
            function formatCurrency(money) {
                return new Intl.NumberFormat('vi-VN').format(money);
            }
        </script>
    </body>
</html> 