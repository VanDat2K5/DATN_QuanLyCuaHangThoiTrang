<!doctype html>
<html class="no-js" lang="en" xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>Profile - StyleTech Store</title>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="author" content="ThemeZaa">
        <meta name="viewport" content="width=device-width,initial-scale=1.0" />
        <meta name="description" content="Profile">
        <!-- favicon icon -->
        <link rel="shortcut icon" href="/images/logoST.png">
        <!-- google fonts preconnect -->
        <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <!-- style sheets and font icons  -->
        <link rel="stylesheet" href="/css/vendors.min.css"/>
        <link rel="stylesheet" href="/css/icon.min.css"/>
        <link rel="stylesheet" href="/css/style.css"/>
        <link rel="stylesheet" href="/css/responsive.css"/>
        <link rel="stylesheet" href="/demos/fashion-store/fashion-store.css" />
        <!-- Bootstrap CSS fallback -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <!-- Feather Icons fallback -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/feather-icons@4.29.0/dist/feather.min.css">
        <!-- Profile specific styles -->
        <link rel="stylesheet" th:href="@{/css/profile.css}" />
        <style>
            .order-item {
                border: 1px solid #e9ecef;
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 15px;
                background: #fff;
                transition: all 0.3s ease;
            }
            
            .order-item:hover {
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                transform: translateY(-2px);
            }
            
            .status-badge {
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 12px;
                font-weight: 500;
            }
            
            .status-ChoXacNhan {
                background: #fff3cd;
                color: #856404;
            }
            
            .status-DaThanhToan {
                background: #d1ecf1;
                color: #0c5460;
            }
            
            .status-DangVanChuyen {
                background: #cce5ff;
                color: #004085;
            }
            
            .status-DaNhanHang {
                background: #d4edda;
                color: #155724;
            }
            
            .status-DaHuy {
                background: #f8d7da;
                color: #721c24;
            }
            
            .pagination .page-link {
                color: #007bff;
                border: 1px solid #dee2e6;
            }
            
            .pagination .page-item.active .page-link {
                background-color: #007bff;
                border-color: #007bff;
                color: white;
            }
            
            .pagination .page-item.disabled .page-link {
                color: #6c757d;
                background-color: #fff;
                border-color: #dee2e6;
            }
            
            .form-select-sm {
                padding: 0.25rem 0.5rem;
                font-size: 0.875rem;
                border-radius: 0.2rem;
            }
        </style>
    </head>
    <body data-mobile-nav-style="classic">
        <div th:replace="Client/header :: header"></div>
        
        <!-- start section -->
        <section class="top-space-margin half-section bg-gradient-very-light-gray">
            <div class="container">
                <div class="row align-items-center justify-content-center" data-anime='{ "el": "childs", "translateY": [-15, 0], "opacity": [0,1], "duration": 300, "delay": 0, "staggervalue": 200, "easing": "easeOutQuad" }'>
                    <div class="col-12 col-xl-8 col-lg-10 text-center position-relative page-title-extra-large">
                        <h1 class="alt-font fw-600 text-dark-gray mb-10px">My Profile</h1> 
                    </div>
                    <div class="col-12 breadcrumb breadcrumb-style-01 d-flex justify-content-center">
                        <ul>
                            <li><a href="/">Home</a></li> 
                            <li>Profile</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
        <!-- end section -->

        <!-- start section -->
        <section class="pt-0 pb-5">
            <div class="container">
                <!-- Alert Messages -->
                <div th:if="${success}" class="alert alert-success alert-dismissible fade show text-dark" role="alert">
                    <i class="feather icon-feather-check-circle me-2"></i>
                    <span th:text="${success}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                <div th:if="${error}" class="alert alert-danger alert-dismissible fade show text-dark" role="alert">
                    <i class="feather icon-feather-alert-circle me-2"></i>
                    <span th:text="${error}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <!-- OAuth Account Creation Notice -->
                <div th:if="${oauthUser and needsAccount}" class="alert alert-warning alert-dismissible fade show text-dark" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="feather icon-feather-alert-triangle me-3 fs-24"></i>
                        <div class="flex-grow-1">
                            <h6 class="mb-1">
                                <i class="feather icon-feather-info me-2"></i>
                                Tạo tài khoản đăng nhập
                            </h6>
                            <p class="mb-2">Bạn đang đăng nhập bằng Google. Để tiện lợi hơn, hãy tạo tên đăng nhập và mật khẩu cho tài khoản của bạn.</p>
                            <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#createAccountModal">
                                <i class="feather icon-feather-user-plus me-2"></i>
                                Tạo tài khoản ngay
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Profile Card -->
                    <div class="col-lg-4 mb-4">
                        <div class="profile-card text-center">
                            <div class="profile-avatar">
                                <i class="feather icon-feather-user"></i>
                            </div>
                            <h3 class="mb-2" th:text="${userRole == 'CUSTOMER' ? user.tenKH : user.tenNV}">User Name</h3>
                            <p class="mb-3" th:text="${userRole == 'CUSTOMER' ? 'Customer' : (userRole == 'ADMIN' ? 'Administrator' : 'Employee')}">Role</p>
                            <div class="badge-row badge-row-1">
                                <span class="badge" th:text="${user.email}">Email</span>
                                <span class="badge" th:text="${userRole == 'CUSTOMER' ? 'CUSTOMER' : (userRole == 'ADMIN' ? 'ADMIN' : 'EMPLOYEE')}">Role</span>
                            </div>
                            <div class="badge-row badge-row-2">
                                <span class="badge" th:if="${oauthUser}" style="background: #ffc107; color: #000;">
                                    <i class="feather icon-feather-log-in me-1"></i>GOOGLE
                                </span>
                                <span class="badge" th:if="${needsAccount}" style="background: #dc3545; color: #fff;">
                                    <i class="feather icon-feather-alert-triangle me-1"></i>CẦN TẠO TÀI KHOẢN
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Content -->
                    <div class="col-lg-8">
                        <ul class="nav nav-tabs" id="profileTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">
                                    <i class="feather icon-feather-bar-chart-2 me-2"></i>Dashboard
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab">
                                    <i class="feather icon-feather-user me-2"></i>Personal Info
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="edit-tab" data-bs-toggle="tab" data-bs-target="#edit" type="button" role="tab">
                                    <i class="feather icon-feather-edit me-2"></i>Edit Profile
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="password-tab" data-bs-toggle="tab" data-bs-target="#password" type="button" role="tab">
                                    <i class="feather icon-feather-lock me-2"></i>Change Password
                                </button>
                            </li>
                            <li class="nav-item" role="presentation" th:if="${oauthUser and needsAccount}">
                                <button class="nav-link" id="account-tab" data-bs-toggle="tab" data-bs-target="#account" type="button" role="tab">
                                    <i class="feather icon-feather-user-plus me-2"></i>Create Account
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content" id="profileTabsContent">
                            <!-- Include Dashboard Fragment -->
                            <div th:replace="Client/fragments/profile-dashboard :: dashboard"></div>
                            
                            <!-- Include Personal Info Fragment -->
                            <div th:replace="Client/fragments/profile-personal-info :: info"></div>
                            
                            <!-- Include Edit Profile Fragment -->
                            <div th:replace="Client/fragments/profile-edit :: edit"></div>
                            
                            <!-- Include Change Password Fragment -->
                            <div th:replace="Client/fragments/profile-change-password :: password"></div>
                            
                            <!-- Include Create Account Fragment -->
                            <div th:if="${oauthUser and needsAccount}" th:replace="Client/fragments/profile-create-account :: account"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- end section -->

        <!-- QR Code Modal -->
        <div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="qrModalLabel">
                            <i class="fa-solid fa-qrcode me-2"></i>
                            Mã QR thanh toán
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <div id="qrCodeContainer"></div>
                        <div class="mt-3">
                            <p class="mb-1"><strong>Mã đơn hàng:</strong> <span id="orderIdDisplay"></span></p>
                            <p class="mb-1"><strong>Số tiền:</strong> <span id="orderAmountDisplay"></span></p>
                            <p class="mb-0"><strong>Người nhận:</strong> <span id="usernameDisplay"></span></p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                        <button type="button" class="btn btn-primary" onclick="downloadQRCode()">
                            <i class="feather icon-feather-download me-2"></i>
                            Tải xuống
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Account Modal -->
        <div class="modal fade" id="createAccountModal" tabindex="-1" aria-labelledby="createAccountModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="createAccountModalLabel">
                            <i class="feather icon-feather-user-plus me-2"></i>
                            Tạo tài khoản đăng nhập
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div th:replace="Client/fragments/profile-create-account :: #account"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div th:replace="Client/footer :: footer"></div>

        <!-- JavaScript Libraries -->
        <script src="/js/vendors.min.js"></script>
        <script src="/js/main.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

        <script>
            // Page size change function
            function changePageSize(size) {
                const currentUrl = new URL(window.location);
                currentUrl.searchParams.set('size', size);
                currentUrl.searchParams.set('page', '0'); // Reset to first page
                window.location.href = currentUrl.toString();
            }

            // QR Code functionality
            document.addEventListener('DOMContentLoaded', function() {
                const qrButtons = document.querySelectorAll('.qr-btn');
                qrButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const orderId = this.getAttribute('data-order-id');
                        const orderMoney = this.getAttribute('data-order-money');
                        const username = this.getAttribute('data-username');
                        
                        // Display order info
                        document.getElementById('orderIdDisplay').textContent = orderId;
                        document.getElementById('orderAmountDisplay').textContent = new Intl.NumberFormat('vi-VN').format(orderMoney) + ' VNĐ';
                        document.getElementById('usernameDisplay').textContent = username;
                        
                        // Generate QR code
                        const qrData = `OrderID: ${orderId}\nAmount: ${orderMoney}\nRecipient: ${username}`;
                        const qrContainer = document.getElementById('qrCodeContainer');
                        qrContainer.innerHTML = '';
                        
                        QRCode.toCanvas(qrContainer, qrData, {
                            width: 200,
                            margin: 2,
                            color: {
                                dark: '#000000',
                                light: '#FFFFFF'
                            }
                        }, function(error) {
                            if (error) {
                                console.error('QR Code generation error:', error);
                                qrContainer.innerHTML = '<p class="text-danger">Lỗi tạo mã QR</p>';
                            }
                        });
                        
                        // Show modal
                        const qrModal = new bootstrap.Modal(document.getElementById('qrModal'));
                        qrModal.show();
                    });
                });
            });

            // Download QR Code
            function downloadQRCode() {
                const canvas = document.querySelector('#qrCodeContainer canvas');
                if (canvas) {
                    const link = document.createElement('a');
                    link.download = 'qr-code.png';
                    link.href = canvas.toDataURL();
                    link.click();
                }
            }

            // Auto-hide alerts after 5 seconds
            setTimeout(function() {
                const alerts = document.querySelectorAll('.alert');
                alerts.forEach(alert => {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                });
            }, 5000);
        </script>
    </body>
</html> 