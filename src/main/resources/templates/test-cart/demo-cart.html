<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Shopping Cart</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- favicon icon -->
    <link rel="shortcut icon" th:href="@{/images/logoST.png}">
    <!-- google fonts preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- style sheets and font icons  -->
    <link rel="stylesheet" th:href="@{/css/vendors.min.css}">
    <link rel="stylesheet" th:href="@{/css/icon.min.css}">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/responsive.css}">
    <link rel="stylesheet" th:href="@{/demos/fashion-store/fashion-store.css}" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9f9f9;
        }
        .cart-wrapper {
            padding: 120px 0;
            max-width: 1200px;
            margin: auto;
            display: flex;
            gap: 30px;
            flex-direction: column;
        }
        .cart-title {
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
        }
        .cart-body {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }
        .cart-container {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            padding: 30px;
            flex: 2;
        }
        .summary-container {
            background: #f0f0f0;
            border-radius: 12px;
            padding: 30px;
            flex: 1;
            height: fit-content;
        }
        .cart-header {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .cart-table img {
            width: 60px;
            height: auto;
        }
        .cart-table th, .cart-table td {
            vertical-align: middle;
        }
        .qty-controls button {
            border: none;
            background: #000;
            color: #fff;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 16px;
        }
        .total-price {
            font-size: 2.4rem;
            font-weight: 700;
        }
        .cart-actions {
            margin-top: 30px;
            text-align: center;
        }
        .cart-actions button {
            border: 1px solid #000;
            background: #fff;
            color: #000;
            margin: 0 5px;
            padding: 10px 20px;
            font-weight: 500;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from {opacity: 0; transform: translateY(10px);}
            to {opacity: 1; transform: translateY(0);}
        }
        @media (max-width: 768px) {
            .cart-body {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
<div th:replace="Client/header :: header"></div>
<div class="cart-wrapper">
    <div class="cart-title">Shopping Cart</div>
    <div class="cart-body">
        <div class="cart-container">
            <div class="cart-header">Your Items</div>
            <input type="hidden" id="cartMaKH" th:value="${maKH}" />
            <div class="table-responsive">
                <table class="table cart-table">
                    <thead class="table-light">
                    <tr>
                        <th></th>
                        <th>Image</th>
                        <th>Product</th>
                        <th>Color</th>
                        <th>Size</th>
                        <th>Quantity</th>
                        <th>Total</th>
                    </tr>
                    </thead>
                    <tbody id="cartBody"></tbody>
                </table>
            </div>
        </div>
        <div class="summary-container">
            <h5 style="font-size: 1.5rem; font-weight: bold">Cart Total</h5>
            <hr>
            <div id="totalPrice" class="total-price mb-3">Total: 0 đ</div>
            <button class="btn btn-dark w-100">Proceed to Checkout</button>
        </div>
    </div>
    <div class="cart-actions">
        <button class="btn" onclick="loadCarts(document.getElementById('cartMaKH').value)">View Cart</button>
        <button class="btn" onclick="deleteSelectedItems()">Delete Selected</button>
        <button class="btn" onclick="deleteAllItems()">Clear Cart</button>
    </div>
</div>
<div th:replace="Client/footer :: footer"></div>
<script th:src="@{/js/jquery.js}"></script>
<script th:src="@{/js/vendors.min.js}"></script>
<script th:src="@{/js/main.js}"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>

<!--<script src="/js/demo-cart.js"></script>-->
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAiQr7IZK9i8x5V0BglQIRLfr0G1ByMkrU",
        authDomain: "datn-d3877.firebaseapp.com",
        databaseURL: "https://datn-d3877-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "datn-d3877",
        storageBucket: "datn-d3877.firebasestorage.app",
        messagingSenderId: "416913725261",
        appId: "1:416913725261:web:b9890b8eabbfeb215c8904",
        measurementId: "G-J0RLZQBK1V"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();


    // --- CARTBOX ---
    function addCart() {
        const maKH = document.getElementById('cartMaKH')?.value;
        const tenSP = document.getElementById('carttenSP')?.textContent.trim();
        const hinhAnh = document.getElementById('cartanhChinh')?.src;
        const mau = document.querySelector('input[name="maMau"]:checked')?.value || '';
        const size = document.querySelector('input[name="maSize"]:checked')?.value || '';
        const soLuong = parseInt(document.getElementById('cartSoLuong')?.value);
        const giaText = document.getElementById('cartGia')?.textContent.replace(/[^\d]/g, '');
        const gia = parseFloat(giaText);

        if (!tenSP || !hinhAnh || !mau || !size || !soLuong || !gia || !maKH) {
            alert("Vui lòng chọn đầy đủ thông tin sản phẩm!");
            return;
        }

        const item = { tenSP, hinhAnh, mau, size, SoLuong: soLuong, Gia: gia };
        const cartRef = db.ref('Cart/' + maKH + '/items');

        // Kiểm tra nếu sản phẩm đã có
        cartRef.once('value').then(snapshot => {
            let exists = false;
            let existingKey = null;
            snapshot.forEach(child => {
                const val = child.val();
                if (val.tenSP === tenSP && val.mau === mau && val.size === size) {
                    exists = true;
                    existingKey = child.key;
                }
            });

            if (exists && existingKey) {
                // Cập nhật số lượng
                const existingItemRef = cartRef.child(existingKey);
                existingItemRef.child('SoLuong').once('value').then(qSnap => {
                    const oldQty = qSnap.val() || 0;
                    existingItemRef.update({ SoLuong: oldQty + soLuong }).then(() => {
                        alert('Đã cập nhật số lượng sản phẩm!');
                        resetCartForm();
                        loadCarts(maKH);
                    });
                });
            } else {
                // Thêm sản phẩm mới
                cartRef.push(item).then(() => {
                    alert('Thêm vào giỏ hàng thành công!');
                    resetCartForm();
                    loadCarts(maKH);
                });
            }
        }).catch(error => {
            console.error("Lỗi thêm giỏ hàng:", error);
            alert("Thêm vào giỏ hàng thất bại!");
        });
    }

    function resetCartForm() {
        document.getElementById('cartSoLuong').value = '1';
        document.querySelectorAll('input[name="maMau"]').forEach(el => el.checked = false);
        document.querySelectorAll('input[name="maSize"]').forEach(el => el.checked = false);
    }




    function loadCarts(maKH) {
        const cartBody = document.getElementById("cartBody");
        cartBody.innerHTML = '';
        let total = 0;

        const cartRef = firebase.database().ref('Cart/' + maKH + '/items');
        cartRef.once('value', snapshot => {
            if (!snapshot.exists()) {
                cartBody.innerHTML = '<tr><td colspan="7" class="text-center">Your cart is empty</td></tr>';
                document.getElementById("totalPrice").textContent = "Total: 0 đ";
                return;
            }

            snapshot.forEach(child => {
                const item = child.val();
                const itemId = child.key;
                const lineTotal = item.Gia * item.SoLuong;
                total += lineTotal;

                const row = document.createElement('tr');
                row.className = 'fade-in';
                row.innerHTML = `
                    <td><input type="checkbox" class="cartCheckbox" data-item-id="${itemId}" onchange="calculateSelectedTotal('${maKH}')"></td>
                    <td><img src="${item.hinhAnh}" alt=""></td>
                    <td>${item.tenSP}</td>
                    <td>${item.mau}</td>
                    <td>${item.size}</td>
                    <td class="qty-controls">
                        <button onclick="changeQuantity('${maKH}', '${itemId}', -1)">–</button>
                        <span id="qty_${itemId}" class="mx-2">${item.SoLuong}</span>
                        <button onclick="changeQuantity('${maKH}', '${itemId}', 1)">+</button>
                    </td>
                    <td>${(lineTotal).toLocaleString()} đ</td>
                `;
                cartBody.appendChild(row);
            });

            document.getElementById("totalPrice").textContent = "Total: " + total.toLocaleString() + " đ";
        });
    }

    function calculateSelectedTotal(maKH) {
        const checkboxes = document.querySelectorAll(".cartCheckbox:checked");
        let total = 0;

        const cartRef = db.ref('Cart/' + maKH + '/items');
        cartRef.once('value', snapshot => {
            snapshot.forEach(child => {
                const item = child.val();
                const itemId = child.key;

                checkboxes.forEach(checkbox => {
                    if (checkbox.getAttribute("data-item-id") === itemId) {
                        total += item.SoLuong * item.Gia;
                    }
                });
            });

            document.getElementById("totalPrice").textContent = "Tổng tiền (đã chọn): " + total.toLocaleString() + " đ";
        });
    }

    function changeQuantity(maKH, itemId, delta) {
        const qtySpan = document.getElementById(`qty_${itemId}`);
        let currentQty = parseInt(qtySpan.textContent);

        let newQty = currentQty + delta;
        if (newQty < 1) return;

        const itemRef = db.ref('Cart/' + maKH + '/items/' + itemId);
        itemRef.child('SoLuong').set(newQty).then(() => {
            loadCarts(maKH);
        });
    }



    function deleteAllItems() {
        const maKH = document.getElementById("cartMaKH").value;
        if (!confirm("Bạn có chắc muốn xóa toàn bộ giỏ hàng?")) return;

        db.ref('Cart/' + maKH + '/items').remove().then(() => {
            loadCarts(maKH);
        });
    }


    function deleteSelectedItems() {
        const maKH = document.getElementById("cartMaKH").value;
        const checkboxes = document.querySelectorAll(".cartCheckbox:checked");

        if (checkboxes.length === 0) {
            alert("Vui lòng chọn sản phẩm để xóa!");
            return;
        }

        if (!confirm("Bạn có chắc chắn muốn xóa các sản phẩm đã chọn?")) return;

        const cartRef = db.ref('Cart/' + maKH + '/items');

        checkboxes.forEach(checkbox => {
            const itemId = checkbox.getAttribute("data-item-id");
            cartRef.child(itemId).remove();
        });

        setTimeout(() => loadCarts(maKH), 500); // chờ chút cho Firebase xử lý xong
    }

</script>
</body>
</html>